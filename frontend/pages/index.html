<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jini</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>
  <div class="app">
    <div class="robot-panel">
      <div class="robot" aria-hidden="true">
        <div class="core" id="robotCore">
          <div class="head" id="head">
            <div class="eye left" id="eyeL"></div>
            <div class="eye right" id="eyeR"></div>
            <div class="mouth" id="mouth"></div>
          </div>
          <div class="body">
            <div class="chest-light" id="chestLight"></div>
          </div>
          <div class="arm left" id="armL"></div>
          <div class="arm right" id="armR"></div>
          <div class="leg left" id="legL"></div>
          <div class="leg right" id="legR"></div>
        </div>
      </div>
      <div>
        <strong>JINI</strong>
        <div class="status" id="status">Ready ‚Äî say "Hello" or press the mic</div>
      </div>
    </div>

    <div class="chat-panel" role="main" aria-live="polite">
      <div class="chat-header">
        <div><strong>Conversation</strong></div>
        <div class="status" id="usage">Online</div>
      </div>

      <div class="chat-history" id="history"></div>

      <div class="composer">
        <input id="prompt" placeholder="Ask Anything...." />
        <button class="btn" id="sendBtn">Send</button>
        <button class="btn" id="micBtn">üéôÔ∏è </button>

      </div>
    </div>
  </div>

  <!-- sounds -->
  <audio id="wakeSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <audio id="processingSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
  <audio id="endSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
    /* ---------- UI elements ---------- */
    const historyEl = document.getElementById("history");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const statusEl = document.getElementById("status");
    const robotCore = document.getElementById("robotCore");
    const mouth = document.getElementById("mouth");
    const eyeL = document.getElementById("eyeL");
    const eyeR = document.getElementById("eyeR");
    const chestLight = document.getElementById("chestLight");

    const wakeSound = document.getElementById("wakeSound");
    const processingSound = document.getElementById("processingSound");
    const endSound = document.getElementById("endSound");

    /* ---------- conversation memory (client) ---------- */
    const memory = []; // list of {role:'user'|'assistant', text}

    /* ---------- helpers ---------- */
    function appendBubble(text, role) {
      const d = document.createElement("div");
      d.className = "bubble " + (role === "user" ? "user" : "ai");
      d.innerHTML = `<strong>${role === "user" ? "You" : "Jini"}:</strong> ${escapeHtml(text)}`;
      historyEl.appendChild(d);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function escapeHtml(s) {
      return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    /* ---------- robot animations ---------- */
    function startTalking() {
      mouth.style.animation = "mouthTalk 0.26s infinite";
      robotCore.classList.add("glow");
      chestLight.style.opacity = "1";
    }
    function stopTalking() {
      mouth.style.animation = "none";
      robotCore.classList.remove("glow");
      chestLight.style.opacity = "0.9";
      endSound.play();
    }
    function blink() {
      eyeL.style.transform = "scaleY(0.15)";
      eyeR.style.transform = "scaleY(0.15)";
      setTimeout(() => { eyeL.style.transform = "scaleY(1)"; eyeR.style.transform = "scaleY(1)"; }, 160);
    }
    setInterval(blink, 5000);

    /* ---------- OpenAI call (server proxy) ---------- */
    async function askServer(prompt) {
      try {
        const reply = await eel.get_ai_response(prompt)();  // Call Python via Eel
        return reply;
      } catch (err) {
        console.error("Eel communication error:", err);
        return "Sorry ‚Äî I couldn‚Äôt reach the AI backend.";
      }
    }

    /* ---------- Speak using browser TTS (robust) ---------- */
    function speakAndAnimate(text) {
      if (!("speechSynthesis" in window)) {
        // fallback: no tts
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1;
      u.onstart = () => { startTalking(); processingSound.pause(); processingSound.currentTime = 0; };
      u.onend = () => { stopTalking(); };
      speechSynthesis.speak(u);
    }

    /* ---------- send typed prompt ---------- */
    async function sendPrompt() {
      const t = promptEl.value.trim();
      if (!t) return;
      appendBubble(t, "user");
      memory.push({ role: "user", text: t });
      promptEl.value = "";
      statusEl.textContent = "Thinking...";
      processingSound.play();

      try {
        const reply = await askServer(t);
        appendBubble(reply, "assistant");
        memory.push({ role: "assistant", text: reply });
        processingSound.pause();
        processingSound.currentTime = 0;
        speakAndAnimate(reply);
        statusEl.textContent = "Ready";
      } catch (err) {
        processingSound.pause();
        processingSound.currentTime = 0;
        appendBubble("Sorry, server error.", "assistant");
        statusEl.textContent = "Error";
      }
    }

    /* ---------- manual microphone (button) ---------- */
    let micRecognition;
    if ("webkitSpeechRecognition" in window) {
      micRecognition = new webkitSpeechRecognition();
      micRecognition.continuous = false;
      micRecognition.interimResults = false;
      micRecognition.lang = "en-US";

      micRecognition.onstart = () => {
        micBtn.textContent = "üéß";
        statusEl.textContent = "Listening...";
        robotCore.classList.add("glow");
      };
      micRecognition.onend = () => {
        micBtn.textContent = "üéôÔ∏è";
        statusEl.textContent = "Ready";
        robotCore.classList.remove("glow");
      };
      micRecognition.onresult = (e) => {
        const spoken = e.results[0][0].transcript;
        appendBubble(spoken, "user");
        memory.push({ role: "user", text: spoken });
        // send to server
        statusEl.textContent = "Thinking...";
        processingSound.play();
        askServer(spoken).then(reply => {
          appendBubble(reply, "assistant");
          memory.push({ role: "assistant", text: reply });
          processingSound.pause();
          processingSound.currentTime = 0;
          speakAndAnimate(reply);
          statusEl.textContent = "Ready";
        }).catch(err => {
          appendBubble("Sorry, server error.", "assistant");
          statusEl.textContent = "Error";
        });
      };

      micBtn.addEventListener("click", () => {
        goTo("mic.html");
      });


    } else {
      micBtn.disabled = true;
      micBtn.textContent = "No mic";
    }

    /* ---------- wake-word listener (Jini) ---------- */
    let listeningWake = true;
    function startWakeListener() {
      if (!("webkitSpeechRecognition" in window)) return;
      const r = new webkitSpeechRecognition();
      r.continuous = false;
      r.interimResults = false;
      r.lang = "en-US";

      r.onresult = (e) => {
        const t = e.results[0][0].transcript.toLowerCase();
        blink();
        if (listeningWake && t.includes("jini")) {
          wakeSound.play();
          // short confirmation and then listen for command
          speakAndAnimate("Yes?");
          setTimeout(listenForCommand, 800);
        } else {
          // keep listening
          r.start();
        }
      };

      r.onend = () => {
        if (listeningWake) r.start();
      };
      r.start();
    }

    function listenForCommand() {
      if (!("webkitSpeechRecognition" in window)) return;
      const cr = new webkitSpeechRecognition();
      cr.continuous = false;
      cr.interimResults = false;
      cr.lang = "en-US";
      statusEl.textContent = "Listening for command...";
      cr.onresult = async (e) => {
        const cmd = e.results[0][0].transcript;
        appendBubble(cmd, "user");
        memory.push({ role: "user", text: cmd });
        statusEl.textContent = "Thinking...";
        processingSound.play();
        const reply = await askServer(cmd);
        appendBubble(reply, "assistant");
        memory.push({ role: "assistant", text: reply });
        processingSound.pause();
        processingSound.currentTime = 0;
        speakAndAnimate(reply);
        statusEl.textContent = "Ready";
      };
      cr.onend = () => { /* if user silent, resume wake listening */ };
      cr.start();
    }

    /* ---------- events ---------- */
    sendBtn.addEventListener("click", sendPrompt);
    promptEl.addEventListener("keydown", (e) => { if (e.key === "Enter") sendPrompt(); });

    startWakeListener();

    // Function to show messages from Python in your UI
    eel.expose(DisplayMessage);
    function DisplayMessage(message) {
      const status = document.getElementById("status");
      if (status) {
        status.textContent = message;
      } else {
        console.log("Status:", message);
      }
    }

    // Function to show user's spoken/sent text
    eel.expose(senderText);
    function senderText(text) {
      const h1 = document.querySelector("h1");
      if (h1) {
        h1.textContent = text;
      }
    }

    // Optional ‚Äî show when AI (JINI) is responding
    eel.expose(ShowHood);
    function ShowHood() {
      const h1 = document.querySelector("h1");
      if (h1) {
        h1.textContent = "ü§ñ JINI is processing...";
      }
    }

  </script>
  <script type="text/javascript" src="/eel.js"></script>
  <script>
    // Reusable navigation helper for Eel or direct browser
    function goTo(page) {
      if (typeof eel !== "undefined") {
        eel.navigate_to(page)();
      } else {
        window.location.href = page;
      }
    }
  </script>
</body>

</html>